name: Production CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  release:
    types: [published]

env:
  ENV: production
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "18"

jobs:
  # Branch Rule Enforcement (only runs on PRs)
  validate-source-branch:
    name: Validate Source Branch
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Check if source branch is develop
        run: |
          SOURCE_BRANCH="${{ github.head_ref }}"
          TARGET_BRANCH="${{ github.base_ref }}"

          echo "Source branch: $SOURCE_BRANCH"
          echo "Target branch: $TARGET_BRANCH"

          # Allow both 'dev' and 'develop' to merge into main
          if [ "$TARGET_BRANCH" = "main" ] && [ "$SOURCE_BRANCH" != "dev" ] && [ "$SOURCE_BRANCH" != "develop" ]; then
            echo "=========================================="
            echo "ERROR: Branch Rule Violation"
            echo "=========================================="
            echo ""
            echo "Only the 'develop' branch can merge into 'main'."
            echo ""
            echo "Current source branch: $SOURCE_BRANCH"
            echo "Target branch: $TARGET_BRANCH"
            echo ""
            echo "To fix this:"
            echo "1. Merge your changes into 'develop' first"
            echo "2. Then create a PR from 'develop' to 'main'"
            echo ""
            echo "This ensures all changes go through the development"
            echo "environment before reaching production."
            echo "=========================================="
            exit 1
          fi

          echo "Branch validation passed!"
          echo "Source branch '$SOURCE_BRANCH' is allowed to merge into '$TARGET_BRANCH'."

      - name: Comment on PR if validation fails
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Branch Rule Violation\n\n**Only the \`develop\` branch can be merged into \`main\`.**\n\nYour current source branch: \`${{ github.head_ref }}\`\nTarget branch: \`${{ github.base_ref }}\`\n\n---\n\n### How to fix this:\n\n1. **Merge your changes into \`develop\` first:**\n   \`\`\`bash\n   git checkout develop\n   git merge ${{ github.head_ref }}\n   git push origin develop\n   \`\`\`\n\n2. **Then create a PR from \`develop\` to \`main\`**\n\n---\n\n### Why this rule exists:\n\nThis ensures:\n- All changes are tested in the development environment first\n- Production deployments are controlled and predictable\n- The \`develop\` branch serves as a staging area before production\n\n**This PR will be blocked until it originates from the \`develop\` branch.**`
            })

  # Code Quality Checks (Stricter for Production)
  lint-and-format:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python linting tools
        run: |
          pip install black flake8 isort mypy

      - name: Run black (format check)
        run: black --check .

      - name: Run isort (import sorting)
        run: isort --check-only .

      - name: Run flake8 (linting)
        run: flake8 src/ --max-line-length=100 --extend-ignore=E203,W503

      - name: Run mypy (type checking)
        run: mypy src/ --ignore-missing-imports

  # Unit Tests (Stricter Coverage for Production)
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run Python unit tests
        run: |
          pytest tests/ \
            --cov=src \
            --cov-report=term \
            --cov-fail-under=0
        env:
          ENV: test

  # Security Scanning (More Thorough)
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install safety
        run: pip install safety

      - name: Check Python dependencies for vulnerabilities
        run: |
          pip install -r requirements.txt
          safety check --json

      - name: Run Bandit security linter
        run: |
          pip install bandit
          bandit -r src/ -ll -f json -o bandit-report.json

      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./

  # Build Lambda Packages (runs on both PR and push for validation)
  build-backend:
    name: Build Backend Packages
    runs-on: ubuntu-latest
    needs: [test, security-scan]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build Lambda Layer (dependencies)
        run: |
          # Use Docker with Amazon Linux 2 to ensure GLIBC compatibility
          docker run --rm \
            --entrypoint bash \
            -v "$PWD":/var/task \
            public.ecr.aws/lambda/python:3.11 \
            -c "pip install -r requirements.txt -t python/ && zip -r lambda-layer.zip python/"

      - name: Build Lambda Code Package
        run: |
          zip -r lambda-code.zip src/

      - name: Upload Lambda layer artifact
        uses: actions/upload-artifact@v4
        with:
          name: lambda-layer-prod
          path: lambda-layer.zip
          retention-days: 30

      - name: Upload Lambda code artifact
        uses: actions/upload-artifact@v4
        with:
          name: lambda-code-prod
          path: lambda-code.zip
          retention-days: 30

  # Manual Approval Gate (only on push, not PRs)
  approve-deployment:
    name: Approve Production Deployment
    runs-on: ubuntu-latest
    needs: [build-backend]
    if: github.event_name == 'push' || github.event_name == 'release'
    environment:
      name: production
      url: https://nba-cap-optimizer.com
    steps:
      - name: Manual approval checkpoint
        run: |
          echo "Production deployment approved by ${{ github.actor }}"
          echo "Proceeding with deployment to production..."

  # Deploy Infrastructure
  deploy-infrastructure:
    name: Deploy Infrastructure (Terraform)
    runs-on: ubuntu-latest
    needs: approve-deployment
    environment: production
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ vars.AWS_DEPLOY_ROLE_NAME || 'nba-cap-github-actions-role' }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        working-directory: ./infrastructure/terraform
        run: terraform init

      - name: Terraform Workspace
        working-directory: ./infrastructure/terraform
        run: |
          terraform workspace select prod || terraform workspace new prod

      - name: Terraform Apply
        working-directory: ./infrastructure/terraform
        run: terraform apply -auto-approve
        env:
          TF_VAR_environment: production
          TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}

      - name: Output infrastructure values
        working-directory: ./infrastructure/terraform
        run: |
          terraform output -json > outputs.json
          echo "API_ENDPOINT=$(terraform output -raw api_endpoint)" >> $GITHUB_OUTPUT
        id: tf-output

      - name: Upload Terraform outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-prod
          path: infrastructure/terraform/outputs.json
          retention-days: 30

  # Deploy Backend Code
  deploy-backend:
    name: Deploy Backend Code
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    environment: production
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ vars.AWS_DEPLOY_ROLE_NAME || 'nba-cap-github-actions-role' }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Lambda layer
        uses: actions/download-artifact@v4
        with:
          name: lambda-layer-prod

      - name: Download Lambda code
        uses: actions/download-artifact@v4
        with:
          name: lambda-code-prod

      - name: Upload Lambda layer to S3
        run: |
          LAYER_KEY="layers/dependencies-${{ github.sha }}.zip"
          aws s3 cp lambda-layer.zip s3://nba-cap-${{ env.ENV }}-data/${LAYER_KEY}
          echo "LAYER_S3_KEY=${LAYER_KEY}" >> $GITHUB_ENV

      - name: Publish Lambda Layer Version
        id: publish-layer
        run: |
          LAYER_ARN=$(aws lambda publish-layer-version \
            --layer-name nba-cap-${{ env.ENV }}-dependencies \
            --content S3Bucket=nba-cap-${{ env.ENV }}-data,S3Key=${{ env.LAYER_S3_KEY }} \
            --compatible-runtimes python3.11 \
            --description "Dependencies for commit ${{ github.sha }}" \
            --query LayerVersionArn \
            --output text)
          echo "layer_arn=${LAYER_ARN}" >> $GITHUB_OUTPUT
          echo "Published layer version: ${LAYER_ARN}"

      - name: Update Lambda Function Layers
        run: |
          LAYER_ARN="${{ steps.publish-layer.outputs.layer_arn }}"

          for function in $(aws lambda list-functions --query 'Functions[?starts_with(FunctionName, `nba-cap-`) && contains(FunctionName, `${{ env.ENV }}`)].FunctionName' --output text); do
            echo "Attaching layer to $function..."
            echo "  - Layer: ${LAYER_ARN}"

            aws lambda update-function-configuration \
              --function-name $function \
              --layers ${LAYER_ARN}

            # Wait for config update to complete
            aws lambda wait function-updated-v2 --function-name $function || true
          done

      - name: Deploy Lambda Code
        run: |
          for function in $(aws lambda list-functions --query 'Functions[?starts_with(FunctionName, `nba-cap-`) && contains(FunctionName, `${{ env.ENV }}`)].FunctionName' --output text); do
            echo "Updating code for $function..."
            aws lambda update-function-code \
              --function-name $function \
              --zip-file fileb://lambda-code.zip

            # Wait for update to complete
            aws lambda wait function-updated --function-name $function

            # Publish new version
            VERSION=$(aws lambda publish-version --function-name $function --query 'Version' --output text)
            echo "Published version $VERSION for $function"
          done

      - name: Wait for Lambda updates to stabilize
        run: sleep 30

  # Auto-Revert on Deployment Failure
  auto-revert:
    name: Auto-Revert on Failure
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-backend]
    if: failure() && (github.event_name == 'push' || github.event_name == 'release')
    permissions:
      contents: write
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Revert merge commit
        run: |
          echo "CRITICAL: Production deployment failed. Reverting merge commit..."

          FAILED_COMMIT="${{ github.sha }}"
          echo "Failed commit: $FAILED_COMMIT"

          # Check if this is a merge commit
          PARENT_COUNT=$(git rev-list --parents -n 1 $FAILED_COMMIT | wc -w)

          if [ $PARENT_COUNT -gt 2 ]; then
            echo "This is a merge commit. Reverting..."
            git revert -m 1 --no-edit $FAILED_COMMIT
            git push origin main
            echo "Successfully reverted merge commit $FAILED_COMMIT"
          else
            echo "This is a regular commit. Reverting..."
            git revert --no-edit $FAILED_COMMIT
            git push origin main
            echo "Successfully reverted commit $FAILED_COMMIT"
          fi

      - name: Create critical incident issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[CRITICAL] Production Deployment Failed - AUTO-REVERTED ${context.sha.substring(0, 7)}`,
              body: `## CRITICAL: Automatic Revert Executed on Production\n\nThe production deployment failed and the merge has been automatically reverted.\n\n**Failed Commit:** ${context.sha}\n**Branch:** main\n**Triggered by:** ${context.actor}\n**Workflow:** ${context.workflow}\n\n### What happened?\nThe production deployment workflow failed after code was merged into \`main\`. To protect production, the merge commit has been automatically reverted.\n\n### Immediate Actions Required:\n1. Review the failed workflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n2. Investigate the root cause\n3. Verify production environment stability\n4. Fix the issue in \`dev\` branch\n5. Test thoroughly before attempting another production deployment\n\n### Need help?\nCheck the workflow logs for details on what failed. Contact the on-call engineer if production is impacted.`,
              labels: ['production', 'critical', 'auto-revert', 'deployment-failure']
            })

  # Deployment Summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: deploy-backend
    if: success() && (github.event_name == 'push' || github.event_name == 'release')
    permissions:
      contents: write
    steps:
      - name: Create success summary
        run: |
          echo "## Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Successful" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- Backend (Lambda functions)" >> $GITHUB_STEP_SUMMARY
          echo "- Database (RDS PostgreSQL)" >> $GITHUB_STEP_SUMMARY
          echo "- Infrastructure (Terraform)" >> $GITHUB_STEP_SUMMARY

      - name: Tag successful deployment
        uses: actions/github-script@v7
        with:
          script: |
            const tagName = `deploy-prod-${new Date().toISOString().split('T')[0]}-${context.sha.substring(0, 7)}`;
            github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${tagName}`,
              sha: context.sha
            });
